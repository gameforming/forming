import pygame
import random
import os
import sys

pygame.init()
WIDTH, HEIGHT = 800, 400
screen = pygame.display.set_mode((WIDTH, HEIGHT))
pygame.display.set_caption("Clock Runner")
clock = pygame.time.Clock()
font = pygame.font.SysFont("Arial", 24)

# Speler
player = pygame.Rect(100, HEIGHT - 60, 40, 40)
player_y_velocity = 0
gravity = 0.35
jump_strength = -9
on_ground = True

# Spikes
spikes = []
spike_timer = 0
spike_interval = 150  # minder spikes = trager spawnen
spike_speed = 3

# Clocks
clocks = []
clock_timer = 0
clock_interval = 250

# Score & leaderboard
score = 0
highscore = 0
game_over = False
leaderboard_file = "leaderboard.txt"

# Moeilijkheidsgraden instellingen
difficulty = "normal"  # default

def set_difficulty(level):
    global spike_interval, spike_speed, clock_interval
    if level == "easy":
        spike_interval = 200
        spike_speed = 2
        clock_interval = 300
    elif level == "hard":
        spike_interval = 100
        spike_speed = 5
        clock_interval = 180
    else:  # normal
        spike_interval = 150
        spike_speed = 3
        clock_interval = 250

def load_leaderboard():
    if os.path.exists(leaderboard_file):
        with open(leaderboard_file, "r") as f:
            try:
                return int(f.read().strip())
            except:
                return 0
    return 0

def save_leaderboard(score):
    with open(leaderboard_file, "w") as f:
        f.write(str(score))

highscore = load_leaderboard()

def reset_game():
    global player, player_y_velocity, on_ground, spikes, spike_timer, score, game_over, clocks, clock_timer
    player.x, player.y = 100, HEIGHT - 60
    player_y_velocity = 0
    on_ground = True
    spikes.clear()
    spike_timer = 0
    clocks.clear()
    clock_timer = 0
    score = 0
    game_over = False

# Buttons (for pygbag/web)
def draw_button(text, rect, active=True):
    color = (0, 180, 0) if active else (100, 100, 100)
    pygame.draw.rect(screen, color, rect)
    txt = font.render(text, True, (255, 255, 255))
    screen.blit(txt, (rect.x + (rect.width - txt.get_width())//2, rect.y + (rect.height - txt.get_height())//2))

button_home_rect = pygame.Rect(WIDTH - 140, 10, 130, 40)
button_easy_rect = pygame.Rect(10, 50, 100, 40)
button_normal_rect = pygame.Rect(120, 50, 120, 40)
button_hard_rect = pygame.Rect(250, 50, 100, 40)

running = True
while running:
    clock.tick(60)
    screen.fill((30, 30, 30))

    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False
        if event.type == pygame.MOUSEBUTTONDOWN:
            mx, my = event.pos
            if button_home_rect.collidepoint(mx, my):
                # Back to homepage: werkt als index.html aanwezig is in pygbag/web omgeving
                if "pygbag" in sys.modules:
                    import webbrowser
                    webbrowser.open("index.html")
                else:
                    print("Back to homepage werkt alleen in pygbag/web omgeving.")
            elif button_easy_rect.collidepoint(mx, my):
                difficulty = "easy"
                set_difficulty(difficulty)
                reset_game()
            elif button_normal_rect.collidepoint(mx, my):
                difficulty = "normal"
                set_difficulty(difficulty)
                reset_game()
            elif button_hard_rect.collidepoint(mx, my):
                difficulty = "hard"
                set_difficulty(difficulty)
                reset_game()

    keys = pygame.key.get_pressed()
    if not game_over:
        if keys[pygame.K_SPACE] and on_ground:
            player_y_velocity = jump_strength
            on_ground = False
    else:
        # Automatisch reset na game over
        reset_game()

    # Beweging speler
    if not game_over:
        player_y_velocity += gravity
        player.y += int(player_y_velocity)

        if player.bottom >= HEIGHT - 20:
            player.bottom = HEIGHT - 20
            player_y_velocity = 0
            on_ground = True

        # Spikes aanmaken
        spike_timer += 1
        if spike_timer >= spike_interval:
            spike_timer = 0
            spike_height = 40
            new_spike = pygame.Rect(WIDTH, HEIGHT - 20 - spike_height, 20, spike_height)
            spikes.append(new_spike)

        # Spikes bewegen en check collision
        for spike in spikes:
            spike.x -= spike_speed
            pygame.draw.rect(screen, (255, 0, 0), spike)
            if player.colliderect(spike):
                game_over = True
                if score > highscore:
                    highscore = score
                    save_leaderboard(highscore)

        spikes = [s for s in spikes if s.right > 0]

        # Clocks aanmaken
        clock_timer += 1
        if clock_timer >= clock_interval:
            clock_timer = 0
            new_clock = pygame.Rect(WIDTH, random.randint(100, HEIGHT - 100), 20, 20)
            clocks.append(new_clock)

        # Clocks bewegen en verzamelen
        for c in clocks:
            c.x -= spike_speed
            pygame.draw.rect(screen, (0, 255, 255), c)
            if player.colliderect(c):
                score += 1
                clocks.remove(c)

        clocks = [c for c in clocks if c.right > 0]

    # Teken speler
    pygame.draw.rect(screen, (255, 255, 0), player)

    # Teken grond
    pygame.draw.rect(screen, (100, 100, 100), (0, HEIGHT - 20, WIDTH, 20))

    # Score en highscore
    score_text = font.render(f"Score: {score}  Highscore: {highscore}", True, (255, 255, 255))
    screen.blit(score_text, (10, 10))

    # Game over tekst
    if game_over:
        game_over_text = font.render("Game Over! Herstart...", True, (255, 100, 100))
        screen.blit(game_over_text, (WIDTH // 2 - game_over_text.get_width() // 2, HEIGHT // 2))

    # Moeilijkheidsgraden knoppen
    draw_button("Easy", button_easy_rect, difficulty=="easy")
    draw_button("Normal", button_normal_rect, difficulty=="normal")
    draw_button("Hard", button_hard_rect, difficulty=="hard")

    # Back to homepage knop
    draw_button("Back to homepage", button_home_rect)

    pygame.display.flip()

pygame.quit()
